#!/bin/bash


set -e
MY_VERBOSITY_LOG_LEVEL=${MY_VERBOSITY_LOG_LEVEL:-1}  # Default level is 1 (INFO)
if [[ "$MY_VERBOSITY_LOG_LEVEL" -ge 2 ]]; then
    set -x
fi


echo "GITHUB_REF=${GITHUB_REF}"
echo "GITHUB_REF_NAME=${GITHUB_REF_NAME}"
echo "OS=${OS}"
echo "VERSION=${VERSION}"
echo "--------------------------------------------------------- evaluating variables"


VERSION="${VERSION:-$(echo ${GITHUB_REF_NAME} | tr / -)}"
OS="${BUILD:-$(uname)}"
ARCH=$(python -c "import platform; n = platform.architecture()[0]; print(n)")

echo "BUILD=${BUILD}"
echo "ARCH=${ARCH}"
echo "OS=${OS}"
echo "VERSION=${VERSION}"  # may be set by the Makefile otherwise empty ??? why


# Check for signed directory
if [[ -d "signed-artifacts" ]]; then
	DIRECTORY="signed-artifacts"
	echo "Found signed artifacts"
else
	if [[ "${CI}" == "true" ]]; then  # GitHub Actions
		mkdir signed-artifacts
		DIRECTORY="signed-artifacts"
		echo "Created signed artifacts directory"
	else
		DIRECTORY="artifacts"
		echo "No signed artifacts found, local build"
	fi
fi
# Create windows installer
mkdir win
cp installer_scripts/template.iss win/win_build.iss
# adds the year and version to the inno installer
info_year=$( date "+%Y" )
copyright_year="#define COPYRIGHT \""${info_year}"\""
version_block="#define VERSION \""${VERSION}"\""
sed -i'' -e '/;inkstitch-year/ a\'$'\n'"${copyright_year}"'' win/win_build.iss
sed -i'' -e '/;inkstitch-version/ a\'$'\n'"${version_block}"'' win/win_build.iss
sed -i'' -e '/;arch-allowed/ a\'$'\n'"ArchitecturesAllowed=x64 arm64"'' win/win_build.iss

iscc win/win_build.iss
mv  win/inkstitch.exe ${DIRECTORY}/inkstitch-${VERSION}-${OS}-${ARCH}.exe
cd dist
echo "Creating zip"


# The python zipfile command line utility can't handle directories
# containing files with UTF-8 names on Windows, so we use 7-zip instead.
7z a ../${DIRECTORY}/inkstitch-${VERSION}-${OS}-${ARCH}.zip *
cd ..
